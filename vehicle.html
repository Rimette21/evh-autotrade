<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D√©tail v√©hicule ‚Äî E.V.H. AUTOTRADE</title>
  <link rel="stylesheet" href="styles.css?v=6">
</head>
<body>
  <header>
    <div class="logo"><img src="images/EVH_logo.png" alt="E.V.H. AUTOTRADE"></div>
    <nav>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="index.html">Catalogue</a></li>
        <li><a href="#">Avantages</a></li>
        <li><a href="#">Acheter</a></li>
        <li><a href="#">√Ä propos</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <a href="index.html" class="back-link">‚Üê Retour au catalogue</a>
    <div id="vehicle-area"><p>Chargement du v√©hicule...</p></div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox">
    <span id="close">&times;</span>
    <img id="lightbox-img" src="">
    <span id="prev">&#10094;</span>
    <span id="next">&#10095;</span>
  </div>

  <script>
    const $mount = document.getElementById('vehicle-area');
    const id = new URLSearchParams(location.search).get('id');
    const placeholderHero='https://via.placeholder.com/1200x800?text=Image+indisponible';
    const placeholderThumb='https://via.placeholder.com/600x400?text=Photo';
    const fixPath = p => !p ? p : (/^https?:\/\//i.test(p) ? p : p.replace(/^\//,''));
    const nfmt = v => Number(v ?? 0).toLocaleString('fr-FR');
    const regFull = s => s || '';

    const parseTransmission = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/Transmission\s+([A-Z\-+]+)/i);
      return m ? m[1] : (specs?.transmission || '');
    };
    const parseAutonomie = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/Autonomie\s*([0-9]+(?:\.[0-9]+)?)\s*km/i);
      return m ? `${m[1]}km` : (specs?.autonomie || specs?.autonomieElectrique || '');
    };
    const parsePlaces = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/(\d+)\s*places/i);
      return m ? `${m[1]} places` : (specs?.places || specs?.seats ? `${specs.places||specs.seats} places` : '');
    };
    const parseTraction = (specs) => {
      if (!specs) return '';
      if (specs.traction || specs.drive) return specs.traction || specs.drive;
      if (/Traction\s+avant/i.test(specs.transmission||'')) return 'FWD (2WD)';
      if (/Traction\s+arri√®re/i.test(specs.transmission||'')) return 'RWD (2WD)';
      if (/4x4|int√©grale|AWD/i.test(specs.transmission||'')) return 'AWD (4WD)';
      return '';
    };

    (async () => {
      if (!id){
        $mount.innerHTML = `<div class="card-box" style="padding:1.1rem;background:#fff3f3;color:#d32f2f;">
          <h2>Erreur</h2><p>Aucun v√©hicule s√©lectionn√©.</p>
          <a href="index.html" class="back-link" style="color:#e53e3e">‚Üê Retour au catalogue</a></div>`;
        return;
      }
      try{
        const url = `data/details/${encodeURIComponent(id)}.json`;
        const res = await fetch(url,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const d = await res.json();

        const features = d.features || d.caracteristiques || [];
        const equip = d.equipements || d.equipment || {};
        const hero = fixPath(d.images?.hero) || placeholderHero;
        const gallery = Array.isArray(d.images?.gallery) ? d.images.gallery.map(fixPath) : [];
        const specs = d.specifications || {};

        const fuel = (features.join(' ').toLowerCase().includes('hybride')) ? 'PHEV' : 'BEV';

        const dims = specs.dimensions || {};
        const dimsStr = (dims.longueur && dims.largeur && dims.hauteur) ? `${dims.longueur} √ó ${dims.largeur} √ó ${dims.hauteur}` : '';
        const poidsStr = (specs.poids || specs.poidsTotal) ? String(specs.poids || specs.poidsTotal) : '';
        const capaciteStr = (specs.capaciteMax || specs.capacite) ? String(specs.capaciteMax || specs.capacite) : '';
        const poidsCap = [poidsStr, capaciteStr].filter(Boolean).join(' / ');

        const allEquip = [
          ...(equip.interieur || equip.interior || []),
          ...(equip.securite || equip.safety || []),
          ...(equip.connectivite || equip.connectivity || [])
        ];
        const half = Math.ceil(allEquip.length/2);

        const moteurVal = specs.moteur || specs.engine || '';
        const puissanceVal = specs.puissance || specs.power || '';
        const transVal = parseTransmission(features, specs);
        const tractionVal = parseTraction(specs);
        const autoVal = parseAutonomie(features, specs);
        const bodyVal = specs.carrosserie || specs.body || '';
        const couleurVal = d.couleur || d.color || specs.couleur || '√Ä pr√©ciser';
        const placesVal = parsePlaces(features, specs);
        const batteryVal = specs.capaciteBatterie || specs.battery || '';

        const line = (label, value, compact=false) => `
          <div class="spec-item ${compact?'spec-compact':''}">
            <span class="spec-label">${label}</span>
            <span class="spec-value">${value || '-'}</span>
          </div>`;

        $mount.innerHTML = `
          <div class="vehicle-header">
            <div class="vehicle-title">
              <h1>${d.name || ''}</h1>
              <div class="vehicle-meta">Mod√®le ${regFull(d.regyear)} ‚Äì R√©f: ${d.id || ''}</div>
            </div>
            <div class="price-stack">
              <div class="price-big">Prix FCR (HT) : ${d.priceFCR || ''}</div>
              <div class="price-sub">d√©douanement possible sous conditions</div>
              <div class="pill">${fuel}</div>
            </div>
          </div>

          <div class="content-grid">
            <!-- images -->
            <div class="card-box image-card">
              <img src="${hero}" class="hero-img" alt="${d.name || 'V√©hicule'}" onerror="this.src='${placeholderHero}'">
              <div class="gallery">
                ${
                  gallery.length
                    ? gallery.map(u => `<img src="${u}" alt="Photo" onerror="this.src='${placeholderThumb}'">`).join('')
                    : '<p class="muted">Aucune image suppl√©mentaire disponible.</p>'
                }
              </div>
            </div>

            <!-- specs a√©r√© -->
            <div class="card-box specs-card">
              <div class="card-title">Sp√©cifications techniques</div>
              <div class="specs-grid">
                ${line('Moteur:', moteurVal)}
                ${line('Puissance moteur:', puissanceVal)}
                ${line('Transmission:', transVal)}
                ${line('Traction:', tractionVal)}
                ${line('Autonomie √©lectrique:', autoVal)}
                ${line('Type de carrosserie:', bodyVal)}
                ${line('Couleur:', couleurVal)}
                ${line('Places:', placesVal)}
              </div>

              <div class="divider"></div>

              <div class="specs-grid">
                ${line('Dimensions (L√ól√óH):', dimsStr, true)}
                ${line('Poids / Capacit√© max:', poidsCap, true)}
                ${line('Batterie:', batteryVal)}
                ${line('Volume coffre:', specs.volumeCoffre || '', true)}
              </div>
            </div>
          </div>

          <div class="card-box equip-card">
            <div class="card-title">√âquipements & Accessoires</div>
            ${
              allEquip.length
                ? `<div class="equip-grid">
                    <ul class="equip-list">${allEquip.slice(0,half).map(x=>`<li>${x}</li>`).join('')}</ul>
                    <ul class="equip-list">${allEquip.slice(half).map(x=>`<li>${x}</li>`).join('')}</ul>
                  </div>`
                : '<p class="muted">Aucun √©quipement list√©.</p>'
            }
          </div>

          <div class="card-box features-card">
            <div class="card-title">Caract√©ristiques principales</div>
            <div class="features-grid">
              <div class="feature"><span class="icon">üóìÔ∏è</span><span>Date d‚Äôimmatriculation : ${regFull(d.regyear)}</span></div>
              <div class="feature"><span class="icon">‚õΩ</span><span>Carburant : ${fuel}</span></div>
              <div class="feature"><span class="icon">üîã</span><span>Batterie : ${batteryVal || '‚Äî'}</span></div>
              <div class="feature"><span class="icon">üìè</span><span>Kilom√©trage : ${nfmt(d.mileage)} km</span></div>
            </div>
          </div>

          <div class="card-box cta-card">
            <a href="#" class="btn">Demander un devis pour ce v√©hicule</a>
          </div>
        `;

        /* Lightbox */
        let currentIndex=0;
        const images = Array.from(document.querySelectorAll('.hero-img, .gallery img'));
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const open = i => { currentIndex=i; lb.style.display='flex'; lbImg.src=images[currentIndex].src; };
        const next = () => { currentIndex=(currentIndex+1)%images.length; lbImg.src=images[currentIndex].src; };
        const prev = () => { currentIndex=(currentIndex-1+images.length)%images.length; lbImg.src=images[currentIndex].src; };
        images.forEach((img,i)=> img.addEventListener('click',()=>open(i)));
        document.getElementById('close').onclick=()=>lb.style.display='none';
        document.getElementById('next').onclick=next;
        document.getElementById('prev').onclick=prev;
        document.addEventListener('keydown',e=>{
          if(lb.style.display==='flex'){
            if(e.key==='ArrowRight') next();
            if(e.key==='ArrowLeft') prev();
            if(e.key==='Escape') lb.style.display='none';
          }
        });

      }catch(e){
        console.error(e);
        $mount.innerHTML = `<div class="card-box" style="padding:1.1rem;background:#fff3f3;color:#d32f2f;text-align:center">
          <h2>V√©hicule non trouv√©</h2>
          <p>ID : ${id}</p>
          <p>Le fichier n‚Äôexiste pas ou a √©t√© supprim√©.</p>
          <a href="index.html" class="back-link" style="color:#e53e3e">‚Üê Retour au catalogue</a></div>`;
      }
    })();
  </script>
</body>
</html>
