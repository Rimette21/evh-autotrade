<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Détail véhicule — E.V.H. Autotrade</title>
  <link rel="stylesheet" href="styles.css?v=18">
  <link rel="stylesheet" href="mobile-tighten.css">
</head>
<body class="page-vehicle">
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo">
          <img src="images/EVH_logo-removebg-preview.png" alt="E.V.H. AUTOTRADE">
        </div>
        <div class="brand">
          <span class="evh">E.V.H.</span>
          <span class="autotrade">Autotrade</span>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation principale">
        <ul>
          <li><a href="index.html">Accueil</a></li>
          <li><a href="index.html#catalogue">Catalogue</a></li>
          <li><a href="index.html#avantages">Avantages</a></li>
          <li><a href="index.html#apropos">À propos</a></li>
          <li><a href="index.html#contact">Contact</a></li>
        </ul>
      </nav>

      <input type="checkbox" id="nav-toggle" aria-hidden="true">
      <label class="nav-btn" for="nav-toggle" aria-label="Ouvrir le menu">
        <span class="bar"></span>
      </label>

      <label for="nav-toggle" class="nav-overlay" aria-hidden="true"></label>
      <aside class="nav-drawer" role="dialog" aria-modal="true" aria-label="Menu mobile">
        <div class="drawer-head">
          <div class="drawer-title">Menu</div>
          <label for="nav-toggle" class="drawer-close" aria-label="Fermer">✕</label>
        </div>
        <div class="drawer-body">
          <nav class="drawer-nav">
            <ul>
              <li><a href="index.html">Accueil</a></li>
              <li><a href="index.html#catalogue">Catalogue</a></li>
              <li><a href="index.html#avantages">Avantages</a></li>
              <li><a href="index.html#apropos">À propos</a></li>
              <li><a href="index.html#contact">Contact</a></li>
            </ul>
          </nav>
        </div>
      </aside>
    </div>
  </header>

  <div class="container--page">
    <a href="index.html#catalogue" class="back-link">← Retour au catalogue</a>
    <div id="vehicle-detail"><p>Chargement du véhicule…</p></div>
  </div>

  <div id="lightbox" aria-hidden="true">
    <span id="close">✕</span>
    <span id="prev">‹</span>
    <img id="lbImg" alt="">
    <span id="next">›</span>
  </div>

  <script>
  (function(){
    const root = document.getElementById('vehicle-detail');

    /* ================== Helpers couleur ================== */
    function normalizeColor(str){
      if(!str) return null;
      const s = String(str).trim().toLowerCase();
      if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(s)) return s;
      const map = {
        "blanc":"#ffffff","blanc nacré":"#f7f7f7","noir":"#111111","noir métallisé":"#222222",
        "gris":"#9aa0a6","gris clair":"#c7cbd1","gris foncé":"#5f666d","argent":"#c0c0c0",
        "bleu":"#1e73be","rouge":"#d93025","vert":"#16a34a","beige":"#d8c6a0"
      };
      return map[s] || null;
    }
    function swatchHTML(value){
      if(!value) return '-';
      const col = normalizeColor(value);
      return col ? '<span class="color-dot" style="--swatch:'+col+'"></span>'+value : value;
    }

    /* ================== Helpers génériques ================== */
    function clean(v){
      if (v == null) return null;
      const s = String(v).trim();
      return (s === '—' || s === '-' || /^n\/?a$/i.test(s)) ? null : s;
    }
    function fmt(v, fallback='—'){ return (v===0 || v) ? String(v) : fallback; }
    function fmtKm(n){ try{ return new Intl.NumberFormat('fr-FR').format(n||0)+' km'; }catch(e){ return (n||0)+' km'; } }
    
    function shortTransm(t){
      if(!t) return '—';
      const s=String(t).toUpperCase();
      if(/DHT/.test(s)) return 'DHT';
      if(/E[- ]?CVT/.test(s)) return 'e-CVT';
      if(/DCT/.test(s)) return 'DCT';
      if(/\bAT\b/.test(s)) return 'AT';
      return t;
    }

    /* ================== Détection Énergie Harmonisée ================== */
    function energyFrom(v){
      const fuel = (v.specifications?.fuelType || '').toLowerCase();
      if (fuel === 'phev' || fuel === 'hybride rechargeable') return 'PHEV';
      if (fuel === 'hev' || fuel === 'hybrid' || fuel === 'hybride') return 'HEV';
      if (fuel === 'bev' || fuel === 'électrique') return 'BEV';

      const hay = [v.name, ...(v.features||[])].join(' ').toLowerCase();
      if (/(phev|plug[- ]?in|hybride.*rechargeable|dm-i|prime)/i.test(hay)) return 'PHEV';
      if (/(hev|hybrid|hybride)(?!.*(rechargeable|plug|prime|phev))/i.test(hay) || 
          /toyota.*hybrid/i.test(hay) || /rav4.*hybrid/i.test(hay)) return 'HEV';
      if (/\b(bev|électrique.*100%|fully electric|ev\b)/i.test(hay)) return 'BEV';
      return '—';
    }

    function powertrainBadge(v){
      const energy = energyFrom(v);
      const labels = {
        'PHEV': 'SUV hybride rechargeable (PHEV)',
        'HEV': 'SUV hybride auto-rechargeable (HEV)',
        'BEV': 'SUV 100% électrique (BEV)'
      };
      return labels[energy] || energy;
    }

    /* ===== Chargement des données ===== */
    const qs = new URLSearchParams(location.search);
    const vehicleId = (qs.get('id') || qs.get('rid') || '').trim();

    if(!vehicleId){
      root.innerHTML = '<div class="error-msg">Aucun identifiant fourni</div>';
      return;
    }
