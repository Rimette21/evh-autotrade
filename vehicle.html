<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Détail véhicule — E.V.H. AUTOTRADE</title>
  <style>
    :root{
      --bg:#e5b34a; --text:#1a1f25; --muted:#6b7280; --white:#fff;
      --shadow:0 6px 24px rgba(0,0,0,.12); --radius-lg:18px; --brand:#e53e3e;
      --green:#20b26b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);line-height:1.55}
    a{color:inherit}
    header{background:#1a1f25;color:#fff;padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .logo img{height:60px}
    nav ul{display:flex;list-style:none;gap:1.5rem}
    nav a{color:#fff;text-decoration:none;font-weight:500}
    .container{max-width:1150px;margin:2rem auto;padding:0 1.25rem}
    .back-link{display:inline-block;color:#0e1726;text-decoration:none;font-weight:600;margin-bottom:1rem}
    .back-link:hover{text-decoration:underline}

    /* header véhicule */
    .vehicle-header{display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:start;margin-bottom:1.25rem}
    .vehicle-title h1{font-size:2.1rem;margin-bottom:.35rem}
    .vehicle-meta{color:var(--muted)}
    .price-stack{text-align:right}
    .price-big{font-size:1.6rem;color:var(--brand);font-weight:800}
    .price-sub{color:#9ca3af;font-size:.9rem;margin-top:.15rem}
    .fuel-pill{display:inline-block;margin-top:.45rem;background:var(--green);color:#fff;font-weight:700;font-size:.8rem;border-radius:999px;padding:.22rem .6rem}

    /* contenu */
    .content-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:1.25rem}
    .card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow)}
    .image-card{padding:1rem}
    .hero-img{width:100%;height:420px;object-fit:cover;border-radius:14px;margin-bottom:1rem;cursor:pointer}
    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
    .gallery img{width:100%;height:130px;object-fit:cover;border-radius:10px;cursor:pointer}

    /* Spécifs : police + petite / valeurs gris foncé / ligne suivante */
    .specs-card{padding:1.05rem}
    .card-title{font-size:1.02rem;font-weight:800;margin-bottom:.7rem}
    .specs-grid{display:grid;grid-template-columns:1fr 1fr;gap:.9rem 1.1rem}
    .spec-item{font-size:.9rem}
    .spec-label{color:var(--muted);display:block;margin-bottom:.12rem}
    .spec-value{display:block;font-weight:600;color:#374151} /* gris foncé */
    .spec-compact .spec-value{font-size:.88rem;white-space:nowrap} /* tient sur une ligne */
    .divider{height:1px;background:#eef2f7;margin:.85rem 0}

    .equip-card{padding:1.05rem;margin-top:1.05rem}
    .equip-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    .equip-list{list-style:none;font-size:.95rem}
    .equip-list li{margin:.35rem 0;padding-left:1.1rem;position:relative}
    .equip-list li::before{content:"•";color:#e53e3e;font-weight:900;position:absolute;left:0;top:.05rem}

    .features-card{padding:1.05rem;margin-top:1.05rem}
    .features-grid{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
    .feature{display:flex;align-items:center;gap:.45rem;font-size:.95rem}
    .feature .icon{font-size:.95rem;color:#111;opacity:.7}

    .cta-card{padding:1.15rem;margin-top:1.05rem;text-align:center}
    .btn{display:inline-block;background:var(--brand);color:#fff;padding:.9rem 1.25rem;border-radius:12px;font-weight:800;font-size:1.05rem;text-decoration:none}
    .btn:hover{filter:brightness(.95)}

    /* Lightbox */
    #lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;align-items:center;justify-content:center;flex-direction:column}
    #lightbox img{max-width:90%;max-height:80%;border-radius:10px}
    #close{position:absolute;top:20px;right:30px;font-size:2rem;color:#fff;cursor:pointer}
    #prev,#next{position:absolute;top:50%;transform:translateY(-50%);font-size:2rem;color:#fff;cursor:pointer}
    #prev{left:30px} #next{right:30px}

    @media (max-width:980px){
      .content-grid{grid-template-columns:1fr}
      .hero-img{height:360px}
      .price-stack{text-align:left}
    }
    @media (max-width:680px){
      .vehicle-title h1{font-size:1.6rem}
      .gallery{grid-template-columns:repeat(2,1fr)}
      .features-grid,.equip-grid,.specs-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="images/EVH_logo.png" alt="E.V.H. AUTOTRADE"></div>
    <nav>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="index.html">Catalogue</a></li>
        <li><a href="#">Avantages</a></li>
        <li><a href="#">Acheter</a></li>
        <li><a href="#">À propos</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <a href="index.html" class="back-link">← Retour au catalogue</a>
    <div id="vehicle-area"><p>Chargement du véhicule...</p></div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox">
    <span id="close">&times;</span>
    <img id="lightbox-img" src="">
    <span id="prev">&#10094;</span>
    <span id="next">&#10095;</span>
  </div>

  <script>
    const $mount = document.getElementById('vehicle-area');
    const id = new URLSearchParams(location.search).get('id');
    const placeholderHero='https://via.placeholder.com/1200x800?text=Image+indisponible';
    const placeholderThumb='https://via.placeholder.com/600x400?text=Photo';
    const fixPath = p => !p ? p : (/^https?:\/\//i.test(p) ? p : p.replace(/^\//,''));
    const nfmt = v => Number(v ?? 0).toLocaleString('fr-FR');
    const regFull = s => s || '';

    const parseTransmission = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/Transmission\s+([A-Z\-+]+)/i);
      return m ? m[1] : (specs?.transmission || '');
    };
    const parseAutonomie = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/Autonomie\s*([0-9]+(?:\.[0-9]+)?)\s*km/i);
      return m ? `${m[1]}km` : (specs?.autonomie || specs?.autonomieElectrique || '');
    };
    const parsePlaces = (features,specs) => {
      const f = (features||[]).join(' ');
      const m = f.match(/(\d+)\s*places/i);
      return m ? `${m[1]} places` : (specs?.places || specs?.seats ? `${specs.places||specs.seats} places` : '');
    };
    const parseTraction = (specs) => {
      if (!specs) return '';
      if (specs.traction || specs.drive) return specs.traction || specs.drive;
      if (/Traction\s+avant/i.test(specs.transmission||'')) return 'FWD (2WD)';
      if (/Traction\s+arrière/i.test(specs.transmission||'')) return 'RWD (2WD)';
      if (/4x4|intégrale|AWD/i.test(specs.transmission||'')) return 'AWD (4WD)';
      return '';
    };

    (async () => {
      if (!id){
        $mount.innerHTML = `<div class="card" style="padding:1.1rem;background:#fff3f3;color:#d32f2f;">
          <h2>Erreur</h2><p>Aucun véhicule sélectionné.</p>
          <a href="index.html" class="back-link" style="color:#e53e3e">← Retour au catalogue</a></div>`;
        return;
      }
      try{
        const url = `data/details/${encodeURIComponent(id)}.json`;
        const res = await fetch(url,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const d = await res.json();

        const features = d.features || d.caracteristiques || [];
        const equip = d.equipment || d.equipements || {};
        const hero = fixPath(d.images?.hero) || placeholderHero;
        const gallery = Array.isArray(d.images?.gallery) ? d.images.gallery.map(fixPath) : [];
        const specs = d.specifications || {};

        /* badge : BEV aussi en vert */
        const fuel = (features.join(' ').toLowerCase().includes('hybride')) ? 'PHEV' : 'BEV';
        const fuelColor = '#20b26b';

        const dims = specs.dimensions || {};
        const dimsStr = (dims.longueur && dims.largeur && dims.hauteur) ? `${dims.longueur} × ${dims.largeur} × ${dims.hauteur}` : '';
        const poidsStr = (specs.poids || specs.poidsTotal) ? String(specs.poids || specs.poidsTotal) : '';
        const capaciteStr = (specs.capaciteMax || specs.capacite) ? String(specs.capaciteMax || specs.capacite) : '';
        const poidsCap = [poidsStr, capaciteStr].filter(Boolean).join(' / ');

        const allEquip = [
          ...(equip.interieur || equip.interior || []),
          ...(equip.securite || equip.safety || []),
          ...(equip.connectivite || equip.connectivity || [])
        ];
        const half = Math.ceil(allEquip.length/2);

        const moteurVal = specs.moteur || specs.engine || '';
        const puissanceVal = specs.puissance || specs.power || '';
        const transVal = parseTransmission(features, specs);
        const tractionVal = parseTraction(specs);
        const autoVal = parseAutonomie(features, specs);
        const bodyVal = specs.carrosserie || specs.body || '';
        const couleurVal = d.couleur || d.color || specs.couleur || 'À préciser';
        const placesVal = parsePlaces(features, specs);
        const batteryVal = specs.capaciteBatterie || specs.battery || '';

        const line = (label, value, compact=false) => `
          <div class="spec-item ${compact?'spec-compact':''}">
            <span class="spec-label">${label}</span>
            <span class="spec-value">${value || '-'}</span>
          </div>`;

        $mount.innerHTML = `
          <div class="vehicle-header">
            <div class="vehicle-title">
              <h1>${d.name || ''}</h1>
              <div class="vehicle-meta">Modèle ${regFull(d.regyear)} – Réf: ${d.id || ''}</div>
            </div>
            <div class="price-stack">
              <div class="price-big">Prix FCR (HT) : ${d.priceFCR || ''}</div>
              <div class="price-sub">dédouanement possible sous conditions</div>
              <div class="fuel-pill" style="background:${fuelColor}">${fuel}</div>
            </div>
          </div>

          <div class="content-grid">
            <div class="card image-card">
              <img src="${hero}" class="hero-img" alt="${d.name || 'Véhicule'}" onerror="this.src='${placeholderHero}'">
              <div class="gallery">
                ${
                  gallery.length
                    ? gallery.map(u => `<img src="${u}" alt="Photo" onerror="this.src='${placeholderThumb}'">`).join('')
                    : '<p style="color:#6b7280">Aucune image supplémentaire disponible.</p>'
                }
              </div>
            </div>

            <div class="card specs-card">
              <div class="card-title">Spécifications techniques</div>
              <div class="specs-grid">
                ${line('Moteur:', moteurVal)}
                ${line('Puissance moteur:', puissanceVal)}
                ${line('Transmission:', transVal)}
                ${line('Traction:', tractionVal)}
                ${line('Autonomie électrique:', autoVal)}
                ${line('Type de carrosserie:', bodyVal)}
                ${line('Couleur:', couleurVal)}
                ${line('Places:', placesVal)}
              </div>

              <div class="divider"></div>

              <div class="specs-grid">
                ${line('Dimensions (L×l×H):', dimsStr, true)}
                ${line('Poids / Capacité max:', poidsCap, true)}
                ${line('Batterie:', batteryVal)}
                ${line('Volume coffre:', specs.volumeCoffre || '', true)}
              </div>
            </div>
          </div>

          <div class="card equip-card">
            <div class="card-title">Équipements & Accessoires</div>
            ${
              allEquip.length
                ? `<div class="equip-grid">
                    <ul class="equip-list">${allEquip.slice(0,half).map(x=>`<li>${x}</li>`).join('')}</ul>
                    <ul class="equip-list">${allEquip.slice(half).map(x=>`<li>${x}</li>`).join('')}</ul>
                  </div>`
                : '<p style="color:#6b7280">Aucun équipement listé.</p>'
            }
          </div>

          <div class="card features-card">
            <div class="card-title">Caractéristiques principales</div>
            <div class="features-grid">
              <div class="feature"><span class="icon">🗓️</span><span>Date d’immatriculation : ${regFull(d.regyear)}</span></div>
              <div class="feature"><span class="icon">⛽</span><span>Carburant : ${fuel}</span></div>
              <div class="feature"><span class="icon">🔋</span><span>Batterie : ${batteryVal || '—'}</span></div>
              <div class="feature"><span class="icon">📏</span><span>Kilométrage : ${nfmt(d.mileage)} km</span></div>
            </div>
          </div>

          <div class="card cta-card">
            <a href="#" class="btn">Demander un devis pour ce véhicule</a>
          </div>
        `;

        /* Lightbox */
        let currentIndex=0;
        const images = Array.from(document.querySelectorAll('.hero-img, .gallery img'));
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const open = i => { currentIndex=i; lb.style.display='flex'; lbImg.src=images[currentIndex].src; };
        const next = () => { currentIndex=(currentIndex+1)%images.length; lbImg.src=images[currentIndex].src; };
        const prev = () => { currentIndex=(currentIndex-1+images.length)%images.length; lbImg.src=images[currentIndex].src; };
        images.forEach((img,i)=> img.addEventListener('click',()=>open(i)));
        document.getElementById('close').onclick=()=>lb.style.display='none';
        document.getElementById('next').onclick=next;
        document.getElementById('prev').onclick=prev;
        document.addEventListener('keydown',e=>{
          if(lb.style.display==='flex'){
            if(e.key==='ArrowRight') next();
            if(e.key==='ArrowLeft') prev();
            if(e.key==='Escape') lb.style.display='none';
          }
        });

      }catch(e){
        console.error(e);
        $mount.innerHTML = `<div class="card" style="padding:1.1rem;background:#fff3f3;color:#d32f2f;text-align:center">
          <h2>Véhicule non trouvé</h2>
          <p>ID : ${id}</p>
          <p>Le fichier n’existe pas ou a été supprimé.</p>
          <a href="index.html" class="back-link" style="color:#e53e3e">← Retour au catalogue</a></div>`;
      }
    })();
  </script>
</body>
</html>
