<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Détail véhicule — E.V.H. AUTOTRADE</title>
  <link rel="stylesheet" href="styles.css?v=17">
  <link rel="stylesheet" href="mobile-tighten.css">
</head>
<body class="page-vehicle">
  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo">
          <img src="images/EVH_logo.png" alt="E.V.H. AUTOTRADE">
        </div>
        <div class="brand">
          <span class="evh">E.V.H.</span>
          <span class="autotrade">AUTOTRADE</span>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation principale">
        <ul>
          <li><a href="index.html">Accueil</a></li>
          <li><a href="index.html#catalogue">Catalogue</a></li>
          <li><a href="index.html#avantages">Avantages</a></li>
          <li><a href="#">À propos</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </nav>

      <input type="checkbox" id="nav-toggle" aria-hidden="true" />
      <label class="nav-btn" for="nav-toggle" aria-label="Ouvrir le menu"><span class="bar"></span></label>

      <label for="nav-toggle" class="nav-overlay" aria-hidden="true"></label>
      <aside class="nav-drawer" role="dialog" aria-modal="true" aria-label="Menu mobile">
        <div class="drawer-head">
          <div class="drawer-title">Menu</div>
          <label for="nav-toggle" class="drawer-close" aria-label="Fermer">✕</label>
        </div>
        <div class="drawer-body">
          <nav class="drawer-nav">
            <ul>
              <li><a href="index.html">Accueil</a></li>
              <li><a href="index.html#catalogue">Catalogue</a></li>
              <li><a href="index.html#avantages">Avantages</a></li>
              <li><a href="#">À propos</a></li>
              <li><a href="#">Contact</a></li>
            </ul>
          </nav>
        </div>
      </aside>
    </div>
  </header>

  <div class="container--page">
    <a href="index.html#catalogue" class="back-link">← Retour au catalogue</a>
    <div id="vehicle-detail"><p>Chargement du véhicule…</p></div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" aria-hidden="true">
    <span id="close">✕</span>
    <span id="prev">‹</span>
    <img id="lbImg" alt="">
    <span id="next">›</span>
  </div>

  <script>
  (function(){
    const root = document.getElementById('vehicle-detail');

    /* ================== Helpers couleur ================== */
    function normalizeColor(str){
      if(!str) return null;
      const s = String(str).trim().toLowerCase();
      if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(s)) return s;
      if(/^rgb\(/.test(s)) return s;
      const map = {
        "blanc":"#ffffff","blanc nacré":"#f7f7f7","noir":"#111111","noir métallisé":"#222222",
        "gris":"#9aa0a6","gris clair":"#c7cbd1","gris foncé":"#5f666d","gris anthracite":"#4a4f55","argent":"#c0c0c0",
        "bleu":"#1e73be","bleu clair":"#7bb6f0","bleu foncé":"#0b3d91",
        "rouge":"#d93025","rouge foncé":"#8b0000",
        "vert":"#16a34a","vert foncé":"#14532d",
        "beige":"#d8c6a0","marron":"#6d4c41","brun":"#5a3825",
        "jaune":"#facc15","orange":"#fb923c","violet":"#7e57c2",
        "bordeaux":"#6d071a","champagne":"#efe3c8","gris métallisé":"#9ea3aa"
      };
      return map[s] || null;
    }
    function swatchHTML(value){
      if(!value) return '-';
      const col = normalizeColor(value);
      return col ? '<span class="color-dot" style="--swatch:'+col+'"></span>'+value : value;
    }

    /* ================== Helpers génériques ================== */
    function clean(v){
      if (v == null) return null;
      const s = String(v).trim();
      if (s === '—' || s === '-' || /^n\/?a$/i.test(s) || /^na$/i.test(s)) return null;
      return s;
    }
    function fmt(v, fallback='—'){ return (v===0 || v) ? String(v) : fallback; }
    function fmtKm(n){ try{ return new Intl.NumberFormat('fr-FR').format(n||0)+' km'; }catch(e){ return (n||0)+' km'; } }
    function shortTransm(t){
      if(!t) return '—';
      const s=String(t).toUpperCase();
      if(/2DHT|DHT/.test(s)) return 'DHT';
      if(/E[- ]?CVT/.test(s)) return 'e-CVT';
      if(/DCT/.test(s)) return 'DCT';
      if(/\bAT\b/.test(s)) return 'AT';
      if(/\bMT\b/.test(s)) return 'MT';
      return t;
    }
    function fuelLabel(data, isPHEV){
      const f = (data.fuel || data.specifications?.fuel || '').toUpperCase();
      if(f) return f;
      return isPHEV ? 'PHEV' : 'BEV';
    }

    /* ===== Récupère l'ID ===== */
    const qs = new URLSearchParams(location.search);
    const vehicleId = (qs.get('id') || qs.get('rid') || qs.get('ref') || qs.get('veh') || '').trim();
    if (qs.get('rid') && !qs.get('id') && vehicleId) {
      history.replaceState({}, '', location.pathname + '?id=' + encodeURIComponent(vehicleId));
    }
    if(!vehicleId){
      root.innerHTML =
        '<div style="background:#fff3f3;color:#b42318;border:1px solid #f1caca;padding:1rem;border-radius:10px;margin:1rem 1.25rem;">'+
          '<strong>Aucun identifiant fourni</strong> — URL attendue : <code>vehicle.html?id=VOTRE_ID</code>'+
        '</div>';
      return;
    }

    /* ===== Chargement JSON ===== */
    const candidates = [
      'data/details/' + encodeURIComponent(vehicleId) + '.json?v=' + Date.now(),
      'data/details/' + encodeURIComponent(vehicleId) + '.json'
    ];
    async function fetchJson(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    (async function load(){
      let data = null;
      for (const u of candidates){
        try{ data = await fetchJson(u); break; }catch(_){}
      }
      if(!data){
        root.innerHTML =
          '<div style="background:#fff3f3;color:#b42318;border:1px solid #f1caca;padding:1rem;border-radius:10px;margin:1rem 1.25rem;">'+
            '<strong>Véhicule non trouvé</strong> — ID : <code>'+vehicleId+'</code>'+
          '</div>';
        return;
      }

      /* ===== Préparation des données ===== */
      const mileageStr = fmtKm(data.mileage);
      const year = (data.regyear || '').split('-')[0] || '—';
      const isPHEV = (data.features || []).some(f => /phev|hybride/i.test(f || ''));
      const energie = isPHEV ? 'PHEV' : 'BEV';
      const fuel = fuelLabel(data, isPHEV);

      const specs = data.specifications || {};
      const items = [];
      function add(label, value){ if (value) items.push({ label, value }); }

      // 1. Moteur & Puissance
      add('Moteur', specs.moteur);
      add('Puissance thermique', specs.puissanceThermique);
      add('Puissance électrique', specs.puissanceElectrique);
      add('Puissance système', specs.puissanceSysteme);
      add('Couple combiné', specs.coupleSysteme);

      // 2. Transmission & Traction
      add('Transmission', specs.transmission);
      let traction = specs.traction || '';
      if (!traction && specs.transmission){
        const m = String(specs.transmission).match(/(traction\s+(avant|arrière|intégrale))|(\b(2wd|4wd|awd)\b)/i);
        if (m) traction = m[0].replace(/2wd/i,'2WD').replace(/4wd/i,'4WD').replace(/awd/i,'AWD');
      }
      add('Traction', traction);

      // 3. Batterie & Recharge
      add('Batterie', specs.batterieKWh ? `${specs.batterieKWh} kWh` : null);
      add('Recharge AC', specs.rechargeACkW ? `${specs.rechargeACkW} kW` : null);
      add('Recharge DC', specs.rechargeDCkW ? `${specs.rechargeDCkW} kW` : null);

      // Autonomie
      const autoElec = clean(specs.autonomieElectrique) ||
                       clean(specs.autonomieWLTP) ||
                       clean(specs.autonomieCLTC) ||
                       clean(specs.autonomieEPA);
      add('Autonomie électrique', autoElec);

      // 4. Dimensions & Capacité
      add('Places', specs.places);
      add('Volume coffre', specs.volumeCoffre);
      if (specs.dimensions) {
        add('Longueur', specs.dimensions.longueur);
        add('Largeur', specs.dimensions.largeur);
        add('Hauteur', specs.dimensions.hauteur);
        add('Empattement', specs.dimensions.empattement);
      }

      // 5. Autres
      add('Pneus', specs.pneus);
      add('Livraison estimée', data.disponibilite);

      const specsHTML = items.map(it =>
        '<div class="spec-item">'+
          '<span class="spec-label">'+it.label+'</span>'+
          '<span class="spec-value">'+it.value+'</span>'+
        '</div>'
      ).join('');

      /* === Équipements & CTA === */
      const eq = data.equipements || {};
      const allEquip = []
        .concat(eq.interieur || [])
        .concat(eq.securite  || [])
        .concat(eq.connectivite || []);

      const equipHtml = allEquip.length ? `
        <div class="card-box equip-card">
          <div class="card-title">Équipements & Accessoires</div>
          <div class="equip-grid">
            <ul class="equip-list">
              ${allEquip.slice(0, Math.ceil(allEquip.length/2)).map(li=>`<li>${li}</li>`).join('')}
            </ul>
            <ul class="equip-list">
              ${allEquip.slice(Math.ceil(allEquip.length/2)).map(li=>`<li>${li}</li>`).join('')}
            </ul>
          </div>
        </div>
      ` : '';

      const ctaHtml = `
        <div class="card-box cta-card">
          <a href="https://wa.me/33650447400" target="_blank" rel="noopener" class="btn">
            Contacter sur WhatsApp
          </a>
        </div>
      `;

      /* ===== Essentials (bandeau haut) ===== */
      const engineCc = specs.engineCc != null ? specs.engineCc : null;
      const transmShort = shortTransm(specs.transmission || data.transmission);
      const essentialsHTML = `
        <div class="essentials">
          <div class="ess-item"><span class="ess-label">Reg. Year</span><span class="ess-value">${year}</span></div>
          <div class="ess-item"><span class="ess-label">Engine (cc)</span><span class="ess-value">${fmt(engineCc)}</span></div>
          <div class="ess-item"><span class="ess-label">Mlg (km)</span><span class="ess-value">${mileageStr}</span></div>
          <div class="ess-item"><span class="ess-label">Fuel</span><span class="ess-value">${fuel}</span></div>
          <div class="ess-item"><span class="ess-label">Transm.</span><span class="ess-value">${fmt(transmShort)}</span></div>
        </div>
      `;

      /* ===== Rendu final ===== */
      root.innerHTML =
        '<div class="vehicle-header">'+
          '<div class="vehicle-title">'+
            '<h1>'+(data.name || 'Véhicule')+'</h1>'+
            '<div class="vehicle-meta">Modèle '+year+' — Réf : <strong>'+data.id+'</strong></div>'+
          '</div>'+
          '<div class="price-stack">'+
            '<div class="price-big">Prix FCR (HT) : '+(data.priceFCR || '-')+'</div>'+
            '<div class="price-sub"><span class="notice notice--customs">(Dédouanement possible sous conditions)</span></div>'+
            '<div style="margin-top:.4rem"><span class="pill">'+energie+'</span></div>'+
          '</div>'+
        '</div>'+
        essentialsHTML +
        '<div class="content-grid">'+
          '<div class="card-box image-card">'+
            '<img src="'+(data.images?.hero || '')+'" alt="'+(data.name || '')+'" class="hero-img" '+
            'onerror="this.src=\'https://via.placeholder.com/800x500?text=Image+non+disponible\'">'+
            '<div class="gallery" id="gallery">'+
              ((data.images?.gallery?.length) ?
                data.images.gallery.map((u,i)=>`<img data-idx="${i}" src="${u}" alt="Vue ${i+1}">`).join('') :
                '<p>Aucune image supplémentaire disponible.</p>')+
            '</div>'+
          '</div>'+
          '<div class="card-box specs-card">'+
            '<div class="card-title">Spécifications techniques</div>'+
            '<div class="specs-grid spec-compact">'+specsHTML+'</div>'+
          '</div>'+
        '</div>' +
        equipHtml + ctaHtml;

      /* ===== Lightbox ===== */
      const galleryImgs = Array.from(document.querySelectorAll('#gallery img'));
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lbImg');
      const btnClose = document.getElementById('close');
      const btnPrev = document.getElementById('prev');
      const btnNext = document.getElementById('next');
      let idx = 0;
      function open(i){ idx=i; lbImg.src = data.images.gallery[idx]; lb.style.display='flex'; }
      function close(){ lb.style.display='none'; lbImg.src=''; }
      function prev(){ open((idx-1+galleryImgs.length)%galleryImgs.length); }
      function next(){ open((idx+1)%galleryImgs.length); }
      galleryImgs.forEach(img => img.addEventListener('click', e => open(+e.target.dataset.idx)));
      btnClose.addEventListener('click', close);
      lb.addEventListener('click', e => { if(e.target===lb) close(); });
      btnPrev.addEventListener('click', prev);
      btnNext.addEventListener('click', next);
      window.addEventListener('keydown', e => {
        if(lb.style.display!=='flex') return;
        if(e.key==='Escape') close();
        if(e.key==='ArrowLeft') prev();
        if(e.key==='ArrowRight') next();
      });
    })();
  })();
  </script>

  <!-- Déplace la pastille .pill dans la photo Hero -->
  <script>
  (function(){
    const root = document.getElementById('vehicle-detail');
    if (!root) return;
    function movePill(){
      const imgCard = root.querySelector('.image-card');
      const pill = root.querySelector('.price-stack .pill');
      if (imgCard && pill){
        let badge = root.querySelector('.energy-badge');
        if (!badge){
          badge = document.createElement('div');
          badge.className = 'energy-badge';
          imgCard.appendChild(badge);
        }
        badge.appendChild(pill);
        return true;
      }
      return false;
    }
    if (!movePill()){
      const obs = new MutationObserver(() => { if (movePill()) obs.disconnect(); });
      obs.observe(root, { childList: true, subtree: true });
    }
  })();
  </script>
</body>
</html>
