<script>
    // Détermine l’énergie : PHEV si on détecte un hybride rechargeable, sinon BEV
    function energyFrom(v){
      const hay = [v.name, ...(v.features||[])].join(' ').toLowerCase();

      if (/(phev|hybride\s*rechargeable|dm-i|plug[- ]?in)/i.test(hay)) return 'PHEV';
      if (/(hev|hybride(?!.*rechargeable))/i.test(hay)) return 'HEV'; 
      if (/\bbev\b|100%\s*électrique|fully electric/i.test(hay)) return 'BEV';
      return '—'; 
    }

    // Format immat YYYY-MM
    function cleanReg(y){
      if(!y) return '—';
      const p=String(y).split('-');
      return p.length===2?`${p[0]}-${p[1]}`:p[0];
    }
    // Cylindrée depuis specs
    function engineCc(v){
      const s=v.specifications||{};
      return s.engineCc||s.enginecc||s.EngineCC||s.cylindree||'—';
    }
    // Sigle court transmission
    function transmissionShort(v){
      const t = (v.specifications && v.specifications.transmission) ? String(v.specifications.transmission) : '';
      const m =
        t.match(/\b(2?DHT)\b/i) ||
        t.match(/\bE[-\s]?CVT\b/i) ||
        t.match(/\bDCT\b/i) ||
        t.match(/\bAT\b/i) ||
        t.match(/\bMT\b/i) ||
        t.match(/\bSingle[-\s]?speed\b/i);
      return m ? m[0].toUpperCase().replace(/\s+/g,'-') : null;
    }
    // "Autonomie 110 km" à partir de specs → features → name
    function autonomyLabel(v){
      const s = v.specifications || {};
      const candidates = [s.autonomieWLTP, s.autonomieCLTC, s.autonomieEPA, s.autonomieElectrique];
      for (const c of candidates){
        if (!c) continue;
        const m = String(c).match(/(\d{2,4})\s*km/i);
        if (m) return `Autonomie ${m[1]} km`;
      }
      const pool = [v.name, ...(v.features||[])].join(' | ');
      const m = pool.match(/(\d{2,4})\s*km/i);
      return m ? `Autonomie ${m[1]} km` : 'Autonomie —';
    }
    // Ruban 5 infos sous l’image
    function quickSpecsHTML(v){
      const reg = cleanReg(v.regyear);
      const cc = engineCc(v);
      const km = (v.mileage != null) ? new Intl.NumberFormat('fr-FR').format(v.mileage) : '—';
      const fuel = energyFrom(v);
      const tr = transmissionShort(v) || '—';
      return `
        <div class="quick-specs">
          <div class="qs-col">
            <span class="qs-label">Reg. Year</span>
            <span class="qs-value">${reg}</span>
          </div>
          <div class="qs-col">
            <span class="qs-label">Engine(cc)</span>
            <span class="qs-value">${cc}</span>
          </div>
          <div class="qs-col">
            <span class="qs-label">Mlg(km)</span>
            <span class="qs-value">${km}</span>
          </div>
          <div class="qs-col">
            <span class="qs-label">Fuel</span>
            <span class="qs-value" style="color:#00aa00;font-weight:700;">${fuel}</span>
          </div>
          <div class="qs-col">
            <span class="qs-label">Transm.</span>
            <span class="qs-value">${tr}</span>
          </div>
        </div>`;
    }

    // ===== Helpers additionnels =====
    const EURO = new Intl.NumberFormat('fr-FR');
    
    function parsePriceEUR(s) {
      if (!s) return null;
      // Cherche le premier groupe de chiffres
      const match = String(s).trim().match(/^(\d{1,3}(?:\s?\d{3})*)/);
      return match ? parseInt(match[1].replace(/\s/g, ''), 10) : null;
    }

    function brandFromName(name){
      if(!name) return '';
      const t = name.split(/\s+/).filter(Boolean);
      return /^\d{4}$/.test(t[0]) ? (t[1] || '') : t[0];
    }
    function yearFromReg(reg){
      if(!reg) return null;
      const y = String(reg).slice(0,4);
      return /^\d{4}$/.test(y) ? parseInt(y,10) : null;
    }
    function kmNum(v){
      return (v.mileage != null) ? parseInt(String(v.mileage).replace(/[^\d]/g,''),10) : 0;
    }
    function energyNormalized(v){
      const e = energyFrom(v).toUpperCase();
      if (e.includes('PHEV')) return 'PHEV';
      if (e.includes('BEV')) return 'BEV';
      if (/(HEV|hybride(?!.*rechargeable))/i.test([v.name, ...(v.features||[])].join(' '))) return 'HEV';
      if (/\bESSENCE\b|gasoline|petrol/i.test([v.name, ...(v.features||[])].join(' '))) return 'ESSENCE';
      if (/\bDIESEL\b/i.test([v.name, ...(v.features||[])].join(' '))) return 'DIESEL';
      return e || '';
    }
    // petite latence pour la recherche texte
    function debounce(fn, ms=250){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    // ===== Rendu d'une carte =====
   function cardHTML(v){
      const energy = energyFrom(v);
      const autoLbl = autonomyLabel(v);
      const trShort = transmissionShort(v) || '—';
      const isSold = v.sold === true;

      const newBadge = v.isNew
        ? `<span class="pill" style="position:absolute;left:10px;top:10px;z-index:2;background:#fef3c7;color:#92400e;border:1px solid #fde68a;">Neuf</span>`
        : '';

      const soldBadge = isSold
        ? `<span class="card-badge card-badge--sold">Vendu</span>`
        : '';

      const energyLabel = (energy === 'PHEV')
        ? 'Hybride rechargeable (PHEV)'
        : '100% électrique (BEV)';

     // On nettoie les features
    const allFeats = Array.isArray(v.features) ? v.features : [];
    const filteredFeats = allFeats.filter(f =>
      !/100%\s*électrique|bev|hybride\s*rechargeable|phev|hev|autonomie/i.test(f || '')
    );
    const specLines = filteredFeats.slice(0, 3);
    const fallbacks = [`Transmission auto ${trShort}`, 'Caméra 360°', 'Toit panoramique'];
    const items = [energyLabel, autoLbl, ...(specLines.length ? specLines : fallbacks)];

      return `
        <a class="card-link" href="vehicle.html?id=${encodeURIComponent(v.id)}">
          <article class="card ${isSold ? 'card--sold' : ''}" style="position:relative">
            ${newBadge}
            ${soldBadge}
            <img
              class="thumb"
              src="${v.images?.hero || ''}"
              alt="${v.name}"
              onerror="this.src='https://via.placeholder.com/400x300?text=Image+non+disponible'">

            ${quickSpecsHTML(v)}

            <div class="body">
              <div class="name">${v.name}</div>
              <div class="submeta">Réf : <strong>${v.id}</strong></div>
              <div class="price">
              <strong>Prix H.T. :</strong> ${v.priceHT || '-'}
              </div>

              ${isSold
                ? '<div class="sold-note">Ce véhicule est déjà vendu</div>'
                : ''
              }

              <ul class="features">
                ${items.map(x=>`<li>• ${x}</li>`).join('')}
              </ul>
            </div>
          </article>
        </a>`;
    }


    function renderGrid(list){
      const grid = document.getElementById('vehicles-grid');
      if(!Array.isArray(list) || list.length === 0){
        grid.innerHTML = '<p>Aucun véhicule ne correspond aux filtres.</p>';
        return;
      }
      grid.innerHTML = list.map(cardHTML).join('');
    }

    // ===== Filtrage principal =====
    function applyFilters(){
      const q = document.getElementById('f-q').value.trim().toLowerCase();
      const type = document.getElementById('f-type').value;
      const yMin = parseInt(document.getElementById('f-year').value,10);
      const kmMax = parseInt(document.getElementById('f-km').value,10);
      const pMax = parseInt(document.getElementById('f-price').value,10);

      const filtered = window.__VEHICLES__.filter(v => {
        const name = (v.name||'').toLowerCase();
        const brand = brandFromName(v.name).toLowerCase();
        const hay = [name, brand, ...(v.features||[])].join(' ').toLowerCase();
        const okQ = !q || hay.includes(q);

        const e = energyNormalized(v);
        const okType = !type || e === type;

        const y = yearFromReg(v.regyear) || 1900;
        const okYear = y >= yMin;

        const km = kmNum(v);
        const okKm = isFinite(kmMax) ? km <= kmMax : true;

        // CORRECTION ICI : suppression des ** **
        const price = parsePriceEUR(v.priceHT) || 0; 
        const okPrice = isFinite(pMax) ? price <= pMax : true;

        return okQ && okType && okYear && okKm && okPrice;
      });

      renderGrid(filtered);
      
      document.getElementById('f-year-val').textContent = yMin;
      document.getElementById('f-km-val').textContent = EURO.format(kmMax) + ' km';
      document.getElementById('f-price-val').textContent = EURO.format(pMax) + ' €';
    }

    // ===== Initialisation =====
    fetch('data/hero.json?v=13', { cache: 'no-store' }) // v13 pour forcer le rafraichissement
      .then(res => res.json())
      .then(vehicles => {
        window.__VEHICLES__ = vehicles || [];

        const years = window.__VEHICLES__.map(v => yearFromReg(v.regyear)).filter(Boolean);
        const kms = window.__VEHICLES__.map(kmNum).filter(n => !isNaN(n));
        const prices = window.__VEHICLES__.map(v => parsePriceEUR(v.priceHT)).filter(n => !isNaN(n));

        const yMin = Math.min(...(years.length?years:[2015]));
        const yMax = Math.max(...(years.length?years:[(new Date()).getFullYear()]));
        const kmMax = Math.max(...(kms.length?kms:[200000]));
        const pMax = Math.max(...(prices.length?prices:[40000]));

        const elYear = document.getElementById('f-year');
        elYear.min = yMin; elYear.max = yMax; elYear.value = yMin;
        document.getElementById('f-year-val').textContent = yMin;

        const elKm = document.getElementById('f-km');
        elKm.min = 0; elKm.max = kmMax; elKm.step = 1000; elKm.value = kmMax;
        document.getElementById('f-km-val').textContent = EURO.format(kmMax) + ' km';

        const elPrice = document.getElementById('f-price');
        elPrice.min = 0; elPrice.max = pMax; elPrice.step = 500; elPrice.value = pMax;
        document.getElementById('f-price-val').textContent = EURO.format(pMax) + ' €';

        renderGrid(window.__VEHICLES__);

        const onInput = debounce(applyFilters, 200);
        document.getElementById('f-q').addEventListener('input', onInput);
        document.getElementById('f-type').addEventListener('change', applyFilters);
        elYear.addEventListener('input', applyFilters);
        elKm.addEventListener('input', applyFilters);
        elPrice.addEventListener('input', applyFilters);

        document.getElementById('f-reset').addEventListener('click', () => {
          document.getElementById('f-q').value = '';
          document.getElementById('f-type').value = '';
          elYear.value = yMin;
          elKm.value = kmMax;
          elPrice.value = pMax;
          applyFilters();
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('vehicles-grid').innerHTML =
          '<p style="color:red;">Erreur : impossible de charger le catalogue.</p>';
      });
  </script>
